#include <stdio.h>
#include <unistd.h>
#include <stdlib.h>
#include <pthread.h>

pthread_mutex_t happy_mutex;


/**
 * worker thread entry point
 */
void *worker(void *varg)
{
    pthread_mutex_lock(&happy_mutex);
    long *counter = (long *)varg;

    printf("thread 0x%0lx starting\n", (long)pthread_self());
    int i = 0;
    for (; i < 100000; i += 1) {
        *counter += 1;
    }
    printf("thread 0x%0lx ending with counter %ld\n", (long)pthread_self(), *counter);

    pthread_mutex_unlock(&happy_mutex);
    return NULL;
}


int
main(int argc, char **argv)
{
    pthread_t thread_a, thread_b;
    pthread_mutex_init(&happy_mutex, NULL);

    // the shared variable - allocated on the heap
    long *counter = malloc(sizeof(long));
    *counter = 0UL;
    
    pthread_create(&thread_a, NULL, worker, counter);
    pthread_create(&thread_b, NULL, worker, counter);

    pthread_join(thread_a, NULL);
    pthread_join(thread_b, NULL);
    
    pthread_mutex_destroy(&happy_mutex);

    printf("end counter value (main thread): %ld\n", *counter);

    free(counter);
    return 0;
}
